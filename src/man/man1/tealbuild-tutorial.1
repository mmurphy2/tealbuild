.\" Automatically generated by Pandoc 2.14.0.1
.\"
.TH "TEALBUILD-TUTORIAL" "1" "June 2021" "TealBuild" ""
.hy
.SH NAME
.PP
tealbuild tutorial - Step-by-step tutorial for using TealBuild
.SH DESCRIPTION
.PP
This document provides a step-by-step quickstart tutorial for using
TealBuild.
To understand what each command does, refer to the man pages for
tealbuild(1) and its individual commands.
Note that this tutorial is written in a conversational style, as opposed
to the formal style of the typical manual page.
.PP
In this tutorial, commands that you type as your regular user directly
onto your computer are denoted with $.
Commands that are run as the root user inside the build VM are denoted
with #.
.IP " 0." 4
If you have not already done so, put the TealBuild script on your PATH
and configure Bash completion by running:
.RS 4
.IP
.nf
\f[C]
$ eval $(/path/to/tealbuild complete)
\f[R]
.fi
.PP
It is a good idea to check that your host computer has all the required
programs needed to run TealBuild.
Perform this check by running:
.IP
.nf
\f[C]
$ tealbuild check-system
\f[R]
.fi
.RE
.IP " 1." 4
Begin by creating the basic TealBuild build tree and configuration file:
.RS 4
.IP
.nf
\f[C]
$ tealbuild new-config
\f[R]
.fi
.RE
.IP " 2." 4
Change to the newly created build tree, and edit the tealbuild.conf file
to put your name in PACKAGER_NAME and your email in PACKAGER_EMAIL.
Also edit the TAG setting to append a unique package build tag for
yourself.
This might start with _ for readability and must consist only of letters
and underscores.
.RS 4
.IP
.nf
\f[C]
$ cd \[ti]/tealbuild
$ vim tealbuild.conf    # or use your favorite editor
\f[R]
.fi
.RE
.IP " 3." 4
Create a new build virtual machine:
.RS 4
.IP
.nf
\f[C]
$ tealbuild vm-install current
\f[R]
.fi
.PP
This step will synchronize a copy of the Slackware(64) software tree to
your computer, then it will build a Slackware -current installation ISO
and boot the VM from it.
Note that it would also be possible to use a released version of
Slackware by specifying the version number instead of \[lq]current\[rq].
In that case, the official DVD ISO would be downloaded from
mirrors.slackware.com, instead of building it locally.
.PP
Once the VM has booted, perform a Slackware installation in the usual
way (which is beyond the scope of this tutorial).
Do a full or terse install using all package sets, and be sure to leave
the rc.sshd service checked to start at boot time.
.RE
.IP " 4." 4
Once the installation is complete, let the setup program reboot the VM.
Log into the VM as root, uncomment a mirror in /etc/slackpkg/mirrors,
and then update the VM by running these commands INSIDE the VM:
.RS 4
.IP
.nf
\f[C]
# slackpkg update gpg
# slackpkg update
# slackpkg upgrade-all
\f[R]
.fi
.PP
If you just synchronized the tree and built the installer ISO in the
previous step, there should not be any updates.
However, this step ensures that slackpkg is ready to update the VM
whenever it needs to be done in the future.
.PP
While we\[cq]re here, let\[cq]s greatly speed up the VM boot time by
lowering the LILO timeout.
Inside the VM, run:
.IP
.nf
\f[C]
# vim /etc/lilo.conf
\f[R]
.fi
.PP
Change the line that reads:
.IP
.nf
\f[C]
timeout = 1200
\f[R]
.fi
.PP
to
.IP
.nf
\f[C]
timeout = 20
\f[R]
.fi
.PP
This will reduce the LILO delay from 2 minutes to 2 seconds.
Save the file and then run:
.IP
.nf
\f[C]
# lilo
\f[R]
.fi
.RE
.IP " 5." 4
Once the LILO timeout has been reduced, configure SSH by running the
following command on your host system (NOT inside the VM) and following
the instructions given:
.RS 4
.IP
.nf
\f[C]
$ tealbuild vm-configure-ssh
\f[R]
.fi
.PP
Once this step is complete, log into the virtual machine and perform an
orderly shutdown by running:
.IP
.nf
\f[C]
# poweroff
\f[R]
.fi
.RE
.IP " 6." 4
You\[cq]re now ready to build your first package.
To do this, we first need to import the package into the ports
collection within the build tree.
Run:
.RS 4
.IP
.nf
\f[C]
$ tealbuild import \[dq]http://slackbuilds.org/slackbuilds/14.2/system/firejail.tar.gz\[dq]
\f[R]
.fi
.RE
.IP " 7." 4
Now take a look at the imported SlackBuild file to be sure everything
looks good.
.RS 4
.IP
.nf
\f[C]
$ cd \[ti]/tealbuild/ports/firejail
$ vim firejail.SlackBuild
\f[R]
.fi
.PP
You can also take a look at firejail.info and the slack-desc file.
.RE
.IP " 8." 4
Notice that we don\[cq]t yet have the source code for firejail itself.
We can have TealBuild grab it for us like this:
.RS 4
.IP
.nf
\f[C]
$ tealbuild fetch-sources firejail
\f[R]
.fi
.PP
Note that we still need to give the package name, even though we\[cq]re
inside the firejail directory.
The source files are actually stored in a separate directory from the
port files.
.RE
.IP " 9." 4
If the download was successful, we\[cq]re ready to build the package.
Be sure the build VM is not running, then give the command:
.RS 4
.IP
.nf
\f[C]
$ tealbuild build firejail
\f[R]
.fi
.PP
This command will start the build VM in snapshot mode, in which any
changes made will be lost upon shutdown.
Once the VM is running, TealBuild will upload the scripts from your port
directory, as well as the sources from the SOURCES directory, into the
VM.
It will then run the SlackBuild for you automatically.
.PP
To view the automatically generated log of the build process, use Bash
completion with the \[lq]log\[rq] command, as shown below.
The build log will have the same base name (the part before the .t?z) as
the package.
.IP
.nf
\f[C]
$ tealbuild log firejail<tab><tab>
\f[R]
.fi
.RE
.IP "10." 4
If the build completed successfully, the resulting Slackware package
will be in your staging directory.
You can view this directory manually:
.RS 4
.IP
.nf
\f[C]
$ cd \[ti]/tealbuild/stage/x86\[rs]_64
$ ls
\f[R]
.fi
.PP
(If building for a different architecture, substitute that architecture
in place of the x86_64.)
.PP
Alternatively, you can view the packages you have in staging using:
.IP
.nf
\f[C]
$ tealbuild stage-list
\f[R]
.fi
.PP
What is the staging directory?
Well, when we first build a package, we might want to test it before
accepting it into our local package repository.
After building a package, it will be installed into the VM
automatically.
Log into the VM, and then check to see if the program is there and
working:
.IP
.nf
\f[C]
# firejail ps ax
\f[R]
.fi
.PP
We know that firejail is working if the ps ax output only shows a few
processes.
The rest of the processes on the system have been hidden by the firejail
sandbox.
.PP
Remember that this automatic installation into the VM is only temporary,
since the VM is in snapshot mode.
As soon as the VM is shut down and restarted, it will be back to a
\[lq]clean\[rq] Slackware installation with no extra packages.
.RE
.IP "11." 4
While we could just install packages out of our staging area, it would
be nice to put them into a proper repository.
With a repository, we could use a third-party package management tool
(like slackpkg+, slapt-get, or slpkg) to install and remove our
packages.
We could also share the repository with other people by uploading it to
a server.
.RS 4
.PP
To create a repository, we first need a GPG key to sign our packages.
Create one by running:
.IP
.nf
\f[C]
$ tealbuild create-gpg-key
\f[R]
.fi
.PP
Enter your name and email when prompted.
For the comment, you might want to label the key with some text
indicating that it is used for building packages.
.PP
Check that your GPG key was properly created by running:
.IP
.nf
\f[C]
$ tealbuild list-gpg-keys
\f[R]
.fi
.RE
.IP "12." 4
Now we need to accept our newly created package into our repository.
Accepting the package signs it and creates the required metadata files
for that package.
We can accept all the packages in our staging area (we only have this
one anyway) by running:
.RS 4
.IP
.nf
\f[C]
$ tealbuild accept
\f[R]
.fi
.RE
.IP "13." 4
Once we have accepted a package into the repository, we need to update
the repository metadata.
To do this, first check that your EDITOR variable is set to the name of
the editor you prefer to use (if it isn\[cq]t already vi).
Run:
.RS 4
.IP
.nf
\f[C]
$ tealbuild update-repo
\f[R]
.fi
.PP
The repository-level metadata will be generated, and your editor will
appear, showing the contents of the ChangeLog.txt that will be created
for the newly accepted packages (any existing ChangeLog will be appended
after your edit this one).
You should just have one ChangeLog entry for the firejail package.
.RE
.IP "14." 4
Once you have closed your editor, your repository update will be
complete, and you\[cq]ll have a local Slackware repository with a newly
built package! However, we can take another step and simulate uploading
the repository to another system.
.RS 4
.PP
Edit the \[ti]/tealbuild/tealbuild.conf file to make the following
changes:
.IP
.nf
\f[C]
    REPO_REMOTE_PATH=\[dq]${HOME}/myrepo\[dq]
\f[R]
.fi
.PP
Then run:
.IP
.nf
\f[C]
$ tealbuild upload-repo
\f[R]
.fi
.PP
You should find a copy of your repository in \[ti]/myrepo.
.PP
We don\[cq]t actually need this copy of the repository in \[ti]/myrepo
for anything else, so you can go ahead and delete it if you want.
.RE
.IP "15." 4
Now we can test that our newly created repository works properly.
Begin by restarting the VM, which clear the installed firejail package
(since snapshot mode is in use):
.RS 4
.IP
.nf
\f[C]
$ tealbuild vm-restart
\f[R]
.fi
.RE
.IP "16." 4
While the VM is restarting, start TealBuild\[cq]s repository test server
by running:
.RS 4
.IP
.nf
\f[C]
$ tealbuild repo-server start
\f[R]
.fi
.PP
The repository test server is just the http.server module that ships
with Python version 3.
It is enough to test that the repository is working.
However, it should not be used in production (i.e.\ to serve the
repository over the Internet).
.RE
.IP "17." 4
Once the VM has restarted, get a shell on the VM by running:
.RS 4
.IP
.nf
\f[C]
$ tealbuild shell
\f[R]
.fi
.PP
Verify that you have a clean VM by trying to run:
.IP
.nf
\f[C]
# firejail ps ax
\f[R]
.fi
.PP
This time, you should get an error that firejail cannot be found.
.RE
.IP "18." 4
In this shell, let\[cq]s download and install slackpkg+ to test our
repo.
Run these commands in the VM shell:
.RS 4
.IP
.nf
\f[C]
# wget \[aq]https://sourceforge.net/projects/slackpkgplus/files/slackpkg%2B-1.7.6-noarch-7mt.txz\[aq]
# installpkg slackpkg+-1.7.6-noarch-7mt.txz
\f[R]
.fi
.PP
Open an editor (vim is shown here) to edit
/etc/slackpkg/slackpkgplus.conf
.IP
.nf
\f[C]
# vim /etc/slackpkg/slackpkgplus.conf
\f[R]
.fi
.PP
Change the REPOPLUS line to read:
.IP
.nf
\f[C]
REPOPLUS=( slackpkgplus myrepo )
\f[R]
.fi
.PP
Add a line below REPOPLUS that reads:
.IP
.nf
\f[C]
MIRRORPLUS[\[aq]myrepo\[aq]]=http://10.0.2.2:8018/x86_64/
\f[R]
.fi
.PP
If you\[cq]re building for a different architecture, substitute that
architecture in place of x86_64 in the above MIRRORPLUS line.
.PP
Save the file and exit the editor.
.RE
.IP "19." 4
Keep using the VM shell, and run:
.RS 4
.IP
.nf
\f[C]
# slackpkg update gpg
# slackpkg update
# slackpkg install firejail
\f[R]
.fi
.PP
If everything was successful, you should see slackpkg+ install the
firejail package from your own repository.
Verify once again that firejail is working by running:
.IP
.nf
\f[C]
# firejail ps ax
\f[R]
.fi
.RE
.IP "20." 4
When you\[cq]re finished with the tutorial, exit the VM shell by
running:
.RS 4
.IP
.nf
\f[C]
# exit
\f[R]
.fi
.PP
Stop the repository server by running:
.IP
.nf
\f[C]
$ tealbuild repo-server stop
\f[R]
.fi
.PP
Finally, to stop the build VM, run:
.IP
.nf
\f[C]
$ tealbuild vm-stop
\f[R]
.fi
.RE
.PP
Congratulations on reaching the end of the tutorial! The next step is to
read the man page for tealbuild(1), which explains basic concepts.
Individual commands are documented in their own man pages.
.PP
Happy building!
.SH SEE ALSO
.PP
tealbuild(1), tealbuild-accept(1), tealbuild-build(1), tealbuild
check-system(1), tealbuild-complete(1), tealbuild-create-gpg-key(1),
tealbuild-fetch-sources(1), tealbuild-import(1),
tealbuild-list-gpg-keys(1), tealbuild-log(1), tealbuild-new-config(1),
tealbuild-repo-server(1), tealbuild-shell(1), tealbuild-stage-list(1),
tealbuild-update-repo, tealbuild-upload-repo(1)
tealbuild-vm-configure-ssh(1), tealbuild-vm-install(1),
tealbuild-vm-restart(1), tealbuild-vm-stop(1)
.SH COPYRIGHT
.PP
Copyright 2021 Coastal Carolina University.
License: MIT.
.SH AUTHORS
Dr.\ Mike Murphy.
